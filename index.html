<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CtrlState â€” Reflexive Influence Simulator</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0b0f;--panel:#12121a;--panel2:#1b1b26;--line:#2b2b3b;
      --text:#e8e8f2;--muted:#a7a7c0;--accent:#39ff14;
      --accent2:#00c2ff;--warn:#ff3d81;--yellow:#ffd400}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:'Press Start 2P',monospace;image-rendering:pixelated}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .btn{cursor:pointer;background:var(--accent);color:#091109;
      border:4px solid #000;outline:2px solid var(--line);
      padding:12px 14px;text-align:center;box-shadow:0 6px 0 #000;
      font-size:12px}
    .btn.alt{background:var(--accent2);color:#001018}
    .btn.warn{background:var(--warn);color:#21000d}
    .start{display:flex;align-items:center;justify-content:center;
      min-height:100dvh;text-align:center;
      background:radial-gradient(ellipse at center,#0f0f17 0%,#08080c 70%);}
    .title{font-size:24px;color:#fff;margin-bottom:16px;text-shadow:0 3px 0 #000,0 0 12px var(--accent2)}
    .subtitle{font-size:10px;color:var(--muted);margin-bottom:18px}
    .screen{display:none}.screen.active{display:block}
    .panel{background:var(--panel);border:4px solid #000;outline:2px solid var(--line);
      padding:16px;box-shadow:0 0 0 4px var(--panel2),0 12px 0 #000}
    .row{display:grid;gap:16px}.cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:2fr 1fr 1fr}
    .flagbox{display:flex;align-items:center;justify-content:center;
      height:120px;background:#0e0e16;border:4px solid #000}
    img.flag{max-width:120px}
    .card-deck{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .card8{background:var(--panel2);border:4px solid #000;outline:2px solid var(--line);
      padding:10px;min-height:100px;cursor:pointer}
    .dropzone{min-height:100px;display:flex;align-items:center;justify-content:center;
      background:#0f0f16;border:4px dashed #000;outline:2px dashed var(--line);
      color:var(--muted);padding:8px}
    .bar{height:18px;border:4px solid #000;outline:2px solid var(--line);margin:6px 0;position:relative}
    .bar>i{position:absolute;top:0;left:0;height:100%;width:0%;background:var(--accent);transition:width 1s}
    #howOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);
      display:none;align-items:center;justify-content:center;z-index:1000}
    #howOverlay.active{display:flex}
    .howBox{background:var(--panel2);border:4px solid #000;outline:2px solid var(--line);
      padding:20px;max-width:600px}
  </style>
</head>
<body>

<!-- How to Play overlay -->
<div id="howOverlay">
  <div class="howBox">
    <h1>How to Play CtrlState</h1>
    <ol>
      <li>Pick Actors (countries + ethics).</li>
      <li>Choose Scenario and drag event cards onto A or B.</li>
      <li>Run Simulation to see results and story.</li>
    </ol>
    <button class="btn alt" onclick="closeHow()">OK, GOT IT</button>
  </div>
</div>

<!-- Start -->
<section id="screenStart" class="start screen active">
  <div>
    <div class="title">CTRLSTATE</div>
    <div class="subtitle">Reflexive Influence Simulator</div>
    <button class="btn" onclick="go('screenActors')">PRESS START</button>
    <div style="margin-top:12px"><a href="#" onclick="showHow();return false;">How to Play</a></div>
  </div>
</section>

<!-- Actors -->
<section id="screenActors" class="wrap screen">
  <div class="panel">
    <h1>Select Actors</h1>
    <div class="row cols-2">
      <div class="panel"><h2>Actor A</h2>
        <input id="a_name" value="Georgia" oninput="loadFlags()">
        <select id="a_eth"><option>Type I</option><option selected>Type II</option></select>
        <div class="flagbox"><img id="a_flag" class="flag"></div>
      </div>
      <div class="panel"><h2>Actor B</h2>
        <input id="b_name" value="Russia" oninput="loadFlags()">
        <select id="b_eth"><option selected>Type I</option><option>Type II</option></select>
        <div class="flagbox"><img id="b_flag" class="flag"></div>
      </div>
    </div>
    <button class="btn alt" onclick="go('screenScenario')">NEXT â–¸</button>
  </div>
</section>

<!-- Scenario -->
<section id="screenScenario" class="wrap screen">
  <div class="panel">
    <h1>Choose Scenario</h1>
    <div class="card-deck">
      <div class="card8" onclick="preset('Elections')">ðŸ—³ Elections</div>
      <div class="card8" onclick="preset('Border')">ðŸš§ Border</div>
      <div class="card8" onclick="preset('Sanctions')">ðŸ’° Sanctions</div>
      <div class="card8" onclick="preset('Cyber')">ðŸ’» Cyber</div>
      <div class="card8" onclick="preset('Custom')">ðŸ›  Custom</div>
    </div>
    <button class="btn alt" onclick="go('screenEvents')">NEXT â–¸</button>
  </div>
</section>

<!-- Events -->
<section id="screenEvents" class="wrap screen">
  <div class="panel">
    <h1>Event Cards</h1>
    <div class="row cols-2">
      <div class="panel"><h2>Actor A</h2><div id="dropA" class="dropzone">DROP HERE</div><div class="flagbox"><img id="a_flag2" class="flag"></div></div>
      <div class="panel"><h2>Actor B</h2><div id="dropB" class="dropzone">DROP HERE</div><div class="flagbox"><img id="b_flag2" class="flag"></div></div>
    </div>
    <div class="card-deck" id="deck"></div>
    <button class="btn alt" onclick="runSim()">RUN SIMULATION â–¸</button>
  </div>
</section>

<!-- Results -->
<section id="screenResults" class="wrap screen">
  <div class="panel">
    <h1>Results</h1>
    <div class="row cols-3">
      <div class="panel">
        <h2>State Shifts</h2>
        <div>Perception <span id="p_pct">0%</span></div><div class="bar"><i id="p_bar"></i></div>
        <div>Policy <span id="q_pct">0%</span></div><div class="bar"><i id="q_bar"></i></div>
        <div>Stability <span id="s_pct">0%</span></div><div class="bar"><i id="s_bar"></i></div>
      </div>
      <div class="panel"><h2>Likely Move</h2><div id="actions"></div></div>
      <div class="panel"><h2>Layers</h2><div id="layers"></div></div>
    </div>
    <pre id="story"></pre>
    <button class="btn alt" onclick="go('screenEvents')">PLAY AGAIN</button>
  </div>
</section>

<script>
const byId=id=>document.getElementById(id);const clamp01=x=>Math.max(0,Math.min(1,x));
function go(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));byId(id).classList.add('active');if(id==='screenEvents')syncFlags();}
function showHow(){byId('howOverlay').classList.add('active');}function closeHow(){byId('howOverlay').classList.remove('active');}

let A={name:"Georgia",ethicalType:"Type II",riskTolerance:.55,domesticFragility:.35,capabilities:.60,infoOpsIntensity:.70,mediaPenetration:.60,alliancePressure:.20,resilience:.50};
let B={name:"Russia",ethicalType:"Type I",riskTolerance:.40,domesticFragility:.45,capabilities:.50,infoOpsIntensity:.40,mediaPenetration:.55,alliancePressure:.60,resilience:.60};

const CARDS=[{id:'prop',title:'PROPAGANDA',d:{infoOpsIntensity:+0.15}},
{id:'media',title:'MEDIA BLITZ',d:{mediaPenetration:+0.15}},
{id:'ally',title:'ALLIANCE PUSH',d:{alliancePressure:+0.20}},
{id:'protest',title:'MASS PROTESTS',d:{domesticFragility:+0.18}},
{id:'cyber',title:'CYBER RAID',d:{capabilities:+0.10,infoOpsIntensity:+0.08}},
{id:'resil',title:'RESILIENCE DRIVE',d:{resilience:+0.20}}];

function renderDeck(){byId('deck').innerHTML=CARDS.map(c=>`<div class="card8" draggable="true" data-id="${c.id}">${c.title}</div>`).join('');
document.querySelectorAll('.card8').forEach(el=>{
el.addEventListener('dragstart',e=>{e.dataTransfer.setData('id',el.dataset.id);});
});}
function initDrops(){['dropA','dropB'].forEach(id=>{const el=byId(id);el.addEventListener('dragover',e=>e.preventDefault());
el.addEventListener('drop',e=>{e.preventDefault();applyCard(id==='dropA'?'A':'B',e.dataTransfer.getData('id'));});});}
function applyCard(t,idc){const c=CARDS.find(x=>x.id===idc);if(!c)return;const o=(t==='A')?A:B;for(let[k,d]of Object.entries(c.d)){o[k]=clamp01((o[k]||0)+d);}}

function compute(A,B){
  const x0=clamp01(0.6*(1-A.domesticFragility)+0.4*A.riskTolerance);
  const x1=clamp01(0.5*B.capabilities+0.5*(1-B.alliancePressure));
  const x2=clamp01(1/(1+Math.exp(-3*(B.infoOpsIntensity*A.mediaPenetration-A.resilience))));
  const rf=clamp01(0.4*x0+0.3*x1+0.3*x2);
  const capRatio=clamp01((A.capabilities+1e-6)/(A.capabilities+B.capabilities+1e-6));
  const E_perc=clamp01(1/(1+Math.exp(-(2*(A.infoOpsIntensity*B.mediaPenetration-B.resilience)+1.2*rf))));
  const E_pol=clamp01(1/(1+Math.exp(-(2.2*(capRatio-B.alliancePressure)+0.8*rf))));
  const E_stab=clamp01(1/(1+Math.exp(-(2*(B.domesticFragility*A.infoOpsIntensity-B.resilience)+1.0*rf))));
  const pCoop=1/(1+Math.exp(-(3*(0.6*(1-A.riskTolerance)+0.4*(1-capRatio))-1.2+0.6*(1-B.alliancePressure))));
  const pCoer=1/(1+Math.exp(-(3*(0.5*capRatio+0.5*A.riskTolerance)+0.5*rf-1.0)));
  const pDecv=1/(1+Math.exp(-(3*(0.6*A.infoOpsIntensity+0.4*rf)-0.8)));
  const pDees=1/(1+Math.exp(-(3*(0.6*B.alliancePressure+0.4*(1-A.riskTolerance))-0.9)));
  const sum=pCoop+pCoer+pDecv+pDees+1e-9;
  return{layers:{x0,x1,x2,rf},impact:{perception:E_perc,policy:E_pol,stability:E_stab},
    actions:[{key:"Cooperate",p:pCoop/sum},{key:"Coerce",p:pCoer/sum},{key:"Deceive",p:pDecv/sum},{key:"De-escalate",p:pDees/sum}]};
}

function runSim(){
  A.name=byId('a_name').value;B.name=byId('b_name').value;
  A.ethicalType=byId('a_eth').value;B.ethicalType=byId('b_eth').value;
  const r=compute(A,B);
  const P=Math.round(r.impact.perception*100),Q=Math.round(r.impact.policy*100),S=Math.round(r.impact.stability*100);
  byId('p_pct').textContent=P+"%";byId('q_pct').textContent=Q+"%";byId('s_pct').textContent=S+"%";
  byId('p_bar').style.width=P+"%";byId('q_bar').style.width=Q+"%";byId('s_bar').style.width=S+"%";
  byId('layers').innerHTML=Object.entries(r.layers).map(([k,v])=>`<div>${k}: ${Math.round(v*100)}%</div>`).join('');
  byId('actions').innerHTML=r.actions.map(a=>`<div>${a.key}: ${(a.p*100).toFixed(1)}%</div>`).join('');
  byId('story').textContent=`${A.name} vs ${B.name}\nDominant channel: ${["Perception","Policy","Stability"].sort((x,y)=>r.impact[x.toLowerCase()]-r.impact[y.toLowerCase()]).pop()}`;
  go('screenResults');
}

function preset(w){/* optional: adjust baselines if you like */}
function loadFlags(){byId('a_flag').src=`https://flagcdn.com/${byId('a_name').value.trim().toLowerCase().slice(0,2)}.svg`;
byId('b_flag').src=`https://flagcdn.com/${byId('b_name').value.trim().toLowerCase().slice(0,2)}.svg`;
syncFlags();}
function syncFlags(){byId('a_flag2').src=byId('a_flag').src;byId('b_flag2').src=byId('b_flag').src;}

renderDeck();initDrops();loadFlags();
</script>
</body>
</html>
