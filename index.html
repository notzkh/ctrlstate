<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CtrlState ‚Äî Reflexive Influence Simulator</title>

  <!-- Retro 8-bit font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#12121a;
      --panel2:#1b1b26;
      --line:#2b2b3b;
      --text:#e8e8f2;
      --muted:#a7a7c0;
      --accent:#39ff14;    /* green for NEXT / primary */
      --accent2:#00c2ff;   /* blue for BACK / secondary */
      --warn:#ff3d81;      /* magenta */
      --yellow:#ffd400;
    }

    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:'Press Start 2P', monospace;
      image-rendering:pixelated;
      letter-spacing:.2px;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    /* Panels / layout */
    .panel{
      background:var(--panel);
      border:4px solid #000; outline:2px solid var(--line);
      padding:18px;
      box-shadow:0 0 0 4px var(--panel2), 0 12px 0 #000;
    }
    .row{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:2fr 1fr 1fr}
    @media(max-width:900px){.cols-2,.cols-3{grid-template-columns:1fr}}

    h1{font-size:18px;color:var(--yellow);margin:0 0 10px;text-shadow:0 2px 0 #000}
    h2{font-size:12px;color:var(--muted);margin:0 0 8px}
    .muted{color:var(--muted);font-size:10px}
    .tiny{font-size:9px}

    /* Inputs & buttons */
    input[type="text"], select{
      width:100%;padding:10px;border:4px solid #000;outline:2px solid var(--line);
      background:#0f0f14;color:var(--text);
    }
    .btn{
      cursor:pointer;
      border:4px solid #000; outline:2px solid var(--line);
      padding:12px 14px; box-shadow:0 6px 0 #000; font-size:12px;
      transition:transform .05s, filter .15s;
      background:var(--accent); color:#091109;
    }
    .btn:hover{filter:brightness(1.1)}
    .btn:active{transform:translateY(2px); box-shadow:0 4px 0 #000}
    .btn.alt{background:var(--accent2); color:#001018}
    .btn.warn{background:var(--warn); color:#21000d}
    .row-nav{margin-top:14px;display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap}

    /* Start screen */
    .start{
      display:flex;align-items:center;justify-content:center;
      min-height:100dvh;text-align:center;
      background:
        radial-gradient(ellipse at center,#0f0f17 0%,#08080c 70%),
        repeating-linear-gradient(90deg,#0c0c12 0 6px,#0b0b11 6px 12px);
    }
    .title{font-size:24px;margin-bottom:16px;text-shadow:0 3px 0 #000,0 0 12px var(--accent2)}
    .subtitle{font-size:10px;color:var(--muted);margin-bottom:18px}

    /* Scenario cards */
    .card-deck{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .card8{
      background:var(--panel2);
      border:4px solid #000; outline:2px solid var(--line);
      padding:10px; cursor:pointer; user-select:none;
      box-shadow:0 6px 0 #000;
    }
    .card8 h3{font-size:11px;color:var(--yellow);margin:0}
    .card8 p{font-size:9px;color:var(--muted);margin:4px 0}
    .card8.selected{box-shadow:0 0 0 4px var(--accent2), 0 0 16px var(--accent2)}

    /* Flags */
    .flagbox{display:flex;align-items:center;justify-content:center;height:120px;background:#0e0e16;border:4px solid #000;outline:2px solid var(--line)}
    img.flag{max-width:120px}

    /* Bars */
    .bar{
      height:18px;border:4px solid #000;outline:2px solid var(--line);
      position:relative; overflow:hidden; margin-top:6px;
      background:repeating-linear-gradient(90deg,#12121a 0 12px,#101018 12px 24px);
    }
    .bar>i{
      position:absolute;top:0;left:0;height:100%;width:0%;
      background:repeating-linear-gradient(90deg,var(--accent) 0 12px,#0f0 12px 24px);
      transition:width 900ms steps(12,end);
    }
    .bar.cyan>i{background:repeating-linear-gradient(90deg,var(--accent2) 0 12px,#0af 12px 24px)}
    .bar.magenta>i{background:repeating-linear-gradient(90deg,var(--warn) 0 12px,#f06 12px 24px)}

    .rowline{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{font-size:10px;background:#0e0e16;border:3px solid #000;outline:2px solid var(--line);padding:5px 8px}
    .fade{opacity:0;animation:fadeUp .6s ease forwards}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* Drag & drop */
    .dropzone{
      min-height:140px;display:flex;align-items:center;justify-content:center;
      background:#0f0f16;border:4px dashed #000;outline:2px dashed var(--line);
      color:var(--muted);text-align:center;padding:8px;transition:.1s;
    }
    .dropzone.active{outline-color:var(--accent);color:var(--accent);transform:scale(1.01)}
    .played{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .mini{font-size:9px;padding:6px 8px;background:#0e0e16;border:3px solid #000;outline:2px solid var(--line)}

    /* Overlay */
    #howOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;
      align-items:center;justify-content:center;z-index:1000;color:var(--text);
    }
    #howOverlay.active{display:flex}
    .howBox{
      background:var(--panel2);border:4px solid #000;outline:2px solid var(--line);
      padding:20px;max-width:720px;box-shadow:0 0 0 4px var(--panel),0 12px 0 #000;
    }
    .howBox h1{font-size:16px;color:var(--yellow);margin:0 0 12px}
    .howBox li{font-size:11px;line-height:1.7;margin:10px 0}
    .screen{display:none}.screen.active{display:block}
  </style>
</head>
<body>

  <!-- How to Play overlay -->
  <div id="howOverlay">
    <div class="howBox">
      <h1>How to Play CtrlState</h1>
      <ol>
        <li><b>Pick Actors:</b> Choose two countries and ethics (Conscience vs Authority).</li>
        <li><b>Select Scenario:</b> Click a scenario card (it highlights).</li>
        <li><b>Play Event Cards:</b> Drag cards onto A or B. Cards are <b>stackable</b>.</li>
        <li><b>Run Simulation:</b> See bars, layers (x‚ÇÄ, x‚ÇÅ, x‚ÇÇ, rf), actions, and a simple story.</li>
      </ol>
      <div style="text-align:center;margin-top:14px">
        <button class="btn alt" onclick="closeHow()">OK, GOT IT</button>
      </div>
    </div>
  </div>

  <!-- Start -->
  <section id="screenStart" class="start screen active">
    <div class="wrap" style="text-align:center;max-width:700px">
      <div class="title">CTRLSTATE</div>
      <div class="subtitle">Reflexive Influence Simulator</div>
      <button class="btn" onclick="go('screenActors'); beep()">PRESS START</button>
      <div class="muted" style="margin-top:12px"><a href="#" onclick="showHow();return false;">How to Play</a></div>
    </div>
  </section>

  <!-- Actors -->
  <section id="screenActors" class="wrap screen">
    <div class="panel">
      <h1>Select Actors</h1>
      <div class="row cols-2" style="margin-top:8px">
        <div class="panel">
          <h2>Actor A (Influencer)</h2>
          <input id="a_name" value="Georgia" oninput="loadFlags()"/>
          <div style="height:8px"></div>
          <label class="muted tiny">Ethics</label>
          <select id="a_eth">
            <option>Type I (Conscience)</option>
            <option selected>Type II (Authority)</option>
          </select>
          <div class="flagbox" style="margin-top:8px"><img id="a_flag" class="flag" alt="A flag"></div>
        </div>
        <div class="panel">
          <h2>Actor B (Target)</h2>
          <input id="b_name" value="Russia" oninput="loadFlags()"/>
          <div style="height:8px"></div>
          <label class="muted tiny">Ethics</label>
          <select id="b_eth">
            <option selected>Type I (Conscience)</option>
            <option>Type II (Authority)</option>
          </select>
          <div class="flagbox" style="margin-top:8px"><img id="b_flag" class="flag" alt="B flag"></div>
        </div>
      </div>
      <div class="row-nav">
        <button class="btn alt" onclick="go('screenStart'); beep()">‚óÇ BACK</button>
        <button class="btn" onclick="go('screenScenario'); beep()">NEXT ‚ñ∏</button>
      </div>
    </div>
  </section>

  <!-- Scenario -->
  <section id="screenScenario" class="wrap screen">
    <div class="panel">
      <h1>Choose a Scenario</h1>
      <div class="card-deck" style="margin-top:8px">
        <div class="card8" data-scenario="Elections" onclick="chooseScenario('Elections')">
          <h3>üó≥ Elections</h3><p>Campaigns & narratives shape public perception.</p>
        </div>
        <div class="card8" data-scenario="Border" onclick="chooseScenario('Border')">
          <h3>üöß Border</h3><p>Force posture and deterrence calculations.</p>
        </div>
        <div class="card8" data-scenario="Sanctions" onclick="chooseScenario('Sanctions')">
          <h3>üí∞ Sanctions</h3><p>Economic pressure rebalances decisions.</p>
        </div>
        <div class="card8" data-scenario="Cyber" onclick="chooseScenario('Cyber')">
          <h3>üíª Cyber</h3><p>Ops degrade trust and capacity.</p>
        </div>
        <div class="card8" data-scenario="Custom" onclick="chooseScenario('Custom')">
          <h3>üõ† Custom</h3><p>Neutral baseline; play your own cards.</p>
        </div>
      </div>
      <div class="row-nav">
        <button class="btn alt" onclick="go('screenActors'); beep()">‚óÇ BACK</button>
        <button id="nextScenario" class="btn" onclick="go('screenEvents'); beep()" disabled>NEXT ‚ñ∏</button>
      </div>
    </div>
  </section>

  <!-- Events -->
  <section id="screenEvents" class="wrap screen">
    <div class="panel">
      <h1>Play Event Cards</h1>
      <div class="muted tiny" style="margin-bottom:10px">Drag a card onto a dropzone. Cards are <b>stackable</b> and remain visible.</div>

      <div class="row cols-2" style="margin-bottom:12px">
        <div class="panel">
          <h2>Actor A</h2>
          <div id="dropA" class="dropzone">DROP CARDS ON A</div>
          <div class="played" id="playedA"></div>
          <div class="flagbox" style="margin-top:10px"><img id="a_flag2" class="flag" alt="A flag 2"></div>
        </div>
        <div class="panel">
          <h2>Actor B</h2>
          <div id="dropB" class="dropzone">DROP CARDS ON B</div>
          <div class="played" id="playedB"></div>
          <div class="flagbox" style="margin-top:10px"><img id="b_flag2" class="flag" alt="B flag 2"></div>
        </div>
      </div>

      <h2>Deck</h2>
      <div class="card-deck" id="deck"></div>

      <div class="row-nav">
        <button class="btn alt" onclick="go('screenScenario'); beep()">‚óÇ BACK</button>
        <div style="display:flex;gap:10px">
          <button class="btn warn" onclick="resetPlayed(); beep()">CLEAR PLAYED</button>
          <button class="btn" onclick="go('screenResults'); runSim(); beep()">NEXT ‚ñ∏</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="screenResults" class="wrap screen">
    <div class="panel">
      <h1>Simulation Results</h1>

      <div class="row cols-3" style="margin-top:10px">
        <div class="panel">
          <h2>State Shifts (A ‚Üí B)</h2>
          <div class="rowline"><span>Perception</span><span class="pill" id="p_pct">0%</span></div>
          <div class="bar"><i id="p_bar"></i></div>
          <div class="rowline" style="margin-top:8px"><span>Policy</span><span class="pill" id="q_pct">0%</span></div>
          <div class="bar cyan"><i id="q_bar"></i></div>
          <div class="rowline" style="margin-top:8px"><span>Stability</span><span class="pill" id="s_pct">0%</span></div>
          <div class="bar magenta"><i id="s_bar"></i></div>
        </div>

        <div class="panel">
          <h2>Likely Move</h2>
          <div class="list" id="actions"></div>
        </div>

        <div class="panel">
          <h2>Ctrl Layers</h2>
          <div class="list" id="layers"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h2>Story</h2>
        <div id="story" class="muted" style="font-size:10px;line-height:1.7"></div>
      </div>

      <div class="row-nav">
        <button class="btn alt" onclick="go('screenEvents'); beep()">‚óÇ BACK</button>
        <div style="display:flex;gap:10px">
          <button class="btn" onclick="exportJSON(); beep()">EXPORT JSON</button>
          <button class="btn" onclick="go('screenEvents'); beep()">PLAY AGAIN ‚ñ∏</button>
        </div>
      </div>
    </div>
  </section>

  <script>
    /* ========= Helpers & audio ========= */
    const byId = id => document.getElementById(id);
    const clamp01 = x => Math.max(0, Math.min(1, +x));
    const sig = z => 1/(1+Math.exp(-z));
    function beep(freq=660, dur=0.06, type='square'){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
        o.start(); g.gain.setValueAtTime(0.04, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
        o.stop(ctx.currentTime+dur);
      }catch(e){}
    }

    /* ========= Navigation (preserve ethics on leave) ========= */
    function go(id){
      if(document.getElementById('screenActors').classList.contains('active')){
        A.ethicalType = byId('a_eth').value;
        B.ethicalType = byId('b_eth').value;
        A.name = byId('a_name').value || 'Actor A';
        B.name = byId('b_name').value || 'Actor B';
      }
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      byId(id).classList.add('active');
      if(id==='screenEvents'){ syncFlags2(); }
    }
    function showHow(){ byId('howOverlay').classList.add('active'); beep(700,0.07); }
    function closeHow(){ byId('howOverlay').classList.remove('active'); beep(500,0.07); }

    /* ========= Actors state ========= */
    let A = { name:"Georgia", ethicalType:"Type II (Authority)", riskTolerance:.55, domesticFragility:.35, capabilities:.60, infoOpsIntensity:.70, mediaPenetration:.60, alliancePressure:.20, resilience:.50 };
    let B = { name:"Russia",  ethicalType:"Type I (Conscience)", riskTolerance:.40, domesticFragility:.45, capabilities:.50, infoOpsIntensity:.40, mediaPenetration:.55, alliancePressure:.60, resilience:.60 };

    function ethicsHuman(s){ return s.includes('Type I') ? 'follows conscience' : 'follows authority'; }

    /* ========= Scenarios (don‚Äôt overwrite ethics) ========= */
    function chooseScenario(which){
      // UI highlight
      document.querySelectorAll('.card8').forEach(c=>c.classList.remove('selected'));
      const el = document.querySelector(`.card8[data-scenario="${which}"]`);
      if(el) el.classList.add('selected');
      byId('nextScenario').disabled = false;

      // Apply baselines (preserving current ethics & names)
      if(which==="Elections"){
        A = { ...A, riskTolerance:.55, domesticFragility:.35, infoOpsIntensity:.70, mediaPenetration:.60, capabilities:.60, alliancePressure:.20, resilience:.50 };
        B = { ...B, riskTolerance:.40, domesticFragility:.45, infoOpsIntensity:.40, mediaPenetration:.55, capabilities:.50, alliancePressure:.60, resilience:.60 };
      } else if(which==="Border"){
        A = { ...A, riskTolerance:.70, domesticFragility:.30, infoOpsIntensity:.50, mediaPenetration:.50, capabilities:.70, alliancePressure:.30, resilience:.55 };
        B = { ...B, riskTolerance:.50, domesticFragility:.40, infoOpsIntensity:.35, mediaPenetration:.50, capabilities:.60, alliancePressure:.65, resilience:.65 };
      } else if(which==="Sanctions"){
        A = { ...A, riskTolerance:.45, domesticFragility:.50, infoOpsIntensity:.50, mediaPenetration:.60, capabilities:.55, alliancePressure:.50, resilience:.60 };
        B = { ...B, riskTolerance:.55, domesticFragility:.35, infoOpsIntensity:.60, mediaPenetration:.55, capabilities:.60, alliancePressure:.25, resilience:.55 };
      } else if(which==="Cyber"){
        A = { ...A, riskTolerance:.60, domesticFragility:.40, infoOpsIntensity:.80, mediaPenetration:.65, capabilities:.55, alliancePressure:.35, resilience:.55 };
        B = { ...B, riskTolerance:.45, domesticFragility:.45, infoOpsIntensity:.45, mediaPenetration:.60, capabilities:.55, alliancePressure:.60, resilience:.65 };
      } else if(which==="Custom"){
        // keep current A/B; baseline already in state
      }
      beep(800,0.06);
    }

    /* ========= Event cards (stackable) ========= */
    const CARDS = [
      { id:'prop',    title:'PROPAGANDA',        desc:'Boost info ops intensity.', deltas:{infoOpsIntensity:+0.15}, tag:'IO' },
      { id:'media',   title:'MEDIA BLITZ',       desc:'Increase media penetration in target.', deltas:{mediaPenetration:+0.15}, tag:'IO' },
      { id:'ally',    title:'ALLIANCE PUSH',     desc:'External pressure on target rises.', deltas:{alliancePressure:+0.20}, tag:'ALLIANCE' },
      { id:'protest', title:'MASS PROTESTS',     desc:'Domestic fragility increases.', deltas:{domesticFragility:+0.18}, tag:'DOMESTIC' },
      { id:'cyber',   title:'CYBER RAID',        desc:'Capacity & IO tick up.', deltas:{capabilities:+0.10, infoOpsIntensity:+0.08}, tag:'CYBER' },
      { id:'resil',   title:'RESILIENCE DRIVE',  desc:'Civic resilience strengthens.', deltas:{resilience:+0.20}, tag:'CIVIC' },
      { id:'deescal', title:'DE-ESCALATE',       desc:'Risk & pressure cool down.', deltas:{riskTolerance:-0.12, alliancePressure:-0.12}, tag:'DE-ESC' }
    ];

    function renderDeck(){
      const deck = byId('deck');
      deck.innerHTML = CARDS.map(c=>`
        <div class="card8" draggable="true" data-card="${c.id}">
          <h3>${c.title}</h3>
          <p class="muted tiny">${c.desc}</p>
          <span class="mini" aria-hidden="true">${c.tag}</span>
        </div>
      `).join('');
      deck.querySelectorAll('.card8').forEach(el=>{
        el.addEventListener('dragstart', e=>{
          e.dataTransfer.setData('text/plain', el.dataset.card);
          document.querySelectorAll('.dropzone').forEach(z=>z.classList.add('active'));
          beep(760,0.05,'sawtooth');
        });
        el.addEventListener('dragend', ()=>{
          document.querySelectorAll('.dropzone').forEach(z=>z.classList.remove('active'));
        });
      });
    }

    function applyCard(target, cardId){
      const c = CARDS.find(x=>x.id===cardId);
      if(!c) return;
      const obj = (target==='A') ? A : B;
      Object.entries(c.deltas).forEach(([k,d])=>{
        obj[k] = clamp01((obj[k]??0) + d); // stackable
      });
      const chip = document.createElement('div');
      chip.className = 'mini';
      chip.textContent = c.title;
      (target==='A' ? byId('playedA') : byId('playedB')).appendChild(chip);
      beep(520,0.06,'square');
    }

    function resetPlayed(){
      byId('playedA').innerHTML = '';
      byId('playedB').innerHTML = '';
      beep(300,0.08,'triangle');
      // Note: this clears chips but does NOT reset stats ‚Äî use scenario again if you want a reset.
    }

    function initDrops(){
      ['dropA','dropB'].forEach(id=>{
        const el = byId(id);
        el.addEventListener('dragover', e=>{ e.preventDefault(); });
        el.addEventListener('dragenter', ()=> el.classList.add('active'));
        el.addEventListener('dragleave', ()=> el.classList.remove('active'));
        el.addEventListener('drop', e=>{
          e.preventDefault();
          const cardId = e.dataTransfer.getData('text/plain');
          applyCard(id==='dropA'?'A':'B', cardId);
          document.querySelectorAll('.dropzone').forEach(z=>z.classList.remove('active'));
        });
      });
    }

    /* ========= Core compute (Lefebvre-inspired) ========= */
    function compute(A,B){
      // Reflexive layers
      const x0 = clamp01(0.6*(1 - A.domesticFragility) + 0.4*A.riskTolerance);
      const x1 = clamp01(0.5*B.capabilities + 0.5*(1 - B.alliancePressure));
      const x2 = clamp01(sig(3*(B.infoOpsIntensity*A.mediaPenetration - A.resilience)));
      const rf = clamp01(0.4*x0 + 0.3*x1 + 0.3*x2);

      // Impact channels
      const capRatio = clamp01((A.capabilities+1e-6)/(A.capabilities+B.capabilities+1e-6));
      const E_perc = clamp01(sig(2.0*(A.infoOpsIntensity*B.mediaPenetration - B.resilience) + 1.2*rf));
      const E_pol  = clamp01(sig(2.2*(capRatio - B.alliancePressure) + 0.8*rf));
      const E_stab = clamp01(sig(2.0*(B.domesticFragility*A.infoOpsIntensity - B.resilience) + 1.0*rf));

      // Action likelihoods
      const pCoop = sig(3*(0.6*(1-A.riskTolerance)+0.4*(1-capRatio)) - 1.2 + 0.6*(1-B.alliancePressure));
      const pCoer = sig(3*(0.5*capRatio + 0.5*A.riskTolerance) + 0.5*rf - 1.0);
      const pDecv = sig(3*(0.6*A.infoOpsIntensity + 0.4*rf) - 0.8);
      const pDees = sig(3*(0.6*B.alliancePressure + 0.4*(1-A.riskTolerance)) - 0.9);
      const sum = pCoop+pCoer+pDecv+pDees + 1e-9;

      return {
        layers:{x0,x1,x2,rf},
        impact:{perception:E_perc, policy:E_pol, stability:E_stab},
        actions:[
          { key:"Cooperate / Engage", p:pCoop/sum },
          { key:"Coerce / Compel",   p:pCoer/sum },
          { key:"Deceive / Influence (IO)", p:pDecv/sum },
          { key:"De-escalate / Pause", p:pDees/sum }
        ]
      };
    }

    /* ========= Results ========= */
    function runSim(){
      // sync names & ethics in case user changed on actors earlier
      A.name = byId('a_name').value || 'Actor A';
      B.name = byId('b_name').value || 'Actor B';
      A.ethicalType = byId('a_eth').value;
      B.ethicalType = byId('b_eth').value;

      const r = compute(A,B);
      const P = Math.round(r.impact.perception*100);
      const Q = Math.round(r.impact.policy*100);
      const S = Math.round(r.impact.stability*100);

      // reset then animate width
      byId('p_bar').style.width='0%'; byId('q_bar').style.width='0%'; byId('s_bar').style.width='0%';
      byId('p_pct').textContent = P+'%';
      byId('q_pct').textContent = Q+'%';
      byId('s_pct').textContent = S+'%';
      setTimeout(()=>{ byId('p_bar').style.width=P+'%'; byId('q_bar').style.width=Q+'%'; byId('s_bar').style.width=S+'%'; },40);

      byId('layers').innerHTML = [
        ['x‚ÇÄ (self-image)', r.layers.x0],
        ['x‚ÇÅ (image of B)', r.layers.x1],
        ['x‚ÇÇ (A thinks B thinks of A)', r.layers.x2],
        ['rf (reflexive factor)', r.layers.rf]
      ].map((l,i)=>`<div class="rowline fade" style="animation-delay:${i*0.15}s"><span>${l[0]}</span><span class="pill">${Math.round(l[1]*100)}%</span></div>`).join('');

      const list = [...r.actions].sort((a,b)=>b.p-a.p);
      byId('actions').innerHTML = list.map((a,i)=>`<div class="rowline fade" style="animation-delay:${i*0.15}s"><span>${a.key}</span><span class="pill">${(a.p*100).toFixed(1)}%</span></div>`).join('');

      const domImpact = [['Perception',r.impact.perception],['Policy',r.impact.policy],['Stability',r.impact.stability]].sort((a,b)=>b[1]-a[1])[0][0];
      const lead = list[0];
      const story = [
        `‚Ä¢ ${A.name} ${ethicsHuman(A.ethicalType)}; ${B.name} ${ethicsHuman(B.ethicalType)}.`,
        `‚Ä¢ ${A.name} feels ${r.layers.x0>0.5?'stronger':'weaker'} inside (x‚ÇÄ=${Math.round(r.layers.x0*100)}%).`,
        `‚Ä¢ ${A.name} sees ${B.name} as ${r.layers.x1>0.5?'powerful':'limited'} (x‚ÇÅ=${Math.round(r.layers.x1*100)}%).`,
        `‚Ä¢ ${A.name} thinks ${B.name} views A as ${r.layers.x2>0.5?'vulnerable':'resilient'} (x‚ÇÇ=${Math.round(r.layers.x2*100)}%).`,
        `‚Ä¢ Dominant channel: ${domImpact}. Likely move: ${lead.key} (${(lead.p*100).toFixed(0)}%).`
      ].join('<br>');
      byId('story').innerHTML = story;
    }

    function exportJSON(){
      const payload = { A, B, result: compute(A,B) };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'ctrlstate_result.json'; a.click();
      URL.revokeObjectURL(url);
      beep(500,0.06);
    }

    /* ========= Flags / maps (case-insensitive + aliases) ========= */
    function loadFlags(){
      const a = byId('a_name').value || '';
      const b = byId('b_name').value || '';
      loadMapImage(a,'a_flag'); loadMapImage(b,'b_flag');
      loadMapImage(a,'a_flag2'); loadMapImage(b,'b_flag2');
    }
    function syncFlags2(){
      loadMapImage(byId('a_name').value,'a_flag2');
      loadMapImage(byId('b_name').value,'b_flag2');
    }
    function loadMapImage(name, targetId){
      if(!name) return;
      const code = COUNTRY_TO_ISO[name.trim().toLowerCase()];
      byId(targetId).src = code ? `https://flagcdn.com/${code}.svg` : '';
    }

    const COUNTRY_TO_ISO = {
      "afghanistan":"af","albania":"al","algeria":"dz","andorra":"ad","angola":"ao","antigua and barbuda":"ag","argentina":"ar","armenia":"am","australia":"au","austria":"at","azerbaijan":"az",
      "bahamas":"bs","bahrain":"bh","bangladesh":"bd","barbados":"bb","belarus":"by","belgium":"be","belize":"bz","benin":"bj","bhutan":"bt","bolivia":"bo","bosnia and herzegovina":"ba",
      "botswana":"bw","brazil":"br","brunei":"bn","bulgaria":"bg","burkina faso":"bf","burundi":"bi","cambodia":"kh","cameroon":"cm","canada":"ca","cape verde":"cv","central african republic":"cf",
      "chad":"td","chile":"cl","china":"cn","colombia":"co","comoros":"km","congo":"cg","congo (democratic republic)":"cd","costa rica":"cr","cote d'ivoire":"ci","ivory coast":"ci","croatia":"hr",
      "cuba":"cu","cyprus":"cy","czechia":"cz","czech republic":"cz","denmark":"dk","djibouti":"dj","dominica":"dm","dominican republic":"do","ecuador":"ec","egypt":"eg","el salvador":"sv",
      "equatorial guinea":"gq","eritrea":"er","estonia":"ee","eswatini":"sz","swaziland":"sz","ethiopia":"et","fiji":"fj","finland":"fi","france":"fr","gabon":"ga","gambia":"gm","georgia":"ge",
      "germany":"de","ghana":"gh","greece":"gr","grenada":"gd","guatemala":"gt","guinea":"gn","guinea-bissau":"gw","guyana":"gy","haiti":"ht","honduras":"hn","hungary":"hu","iceland":"is",
      "india":"in","indonesia":"id","iran":"ir","iraq":"iq","ireland":"ie","israel":"il","italy":"it","jamaica":"jm","japan":"jp","jordan":"jo","kazakhstan":"kz","kenya":"ke","kiribati":"ki",
      "korea (north)":"kp","north korea":"kp","korea (south)":"kr","south korea":"kr","kosovo":"xk","kuwait":"kw","kyrgyzstan":"kg","laos":"la","latvia":"lv","lebanon":"lb","lesotho":"ls",
      "liberia":"lr","libya":"ly","liechtenstein":"li","lithuania":"lt","luxembourg":"lu","madagascar":"mg","malawi":"mw","malaysia":"my","maldives":"mv","mali":"ml","malta":"mt",
      "marshall islands":"mh","mauritania":"mr","mauritius":"mu","mexico":"mx","micronesia":"fm","moldova":"md","monaco":"mc","mongolia":"mn","montenegro":"me","morocco":"ma","mozambique":"mz",
      "myanmar":"mm","burma":"mm","namibia":"na","nauru":"nr","nepal":"np","netherlands":"nl","new zealand":"nz","nicaragua":"ni","niger":"ne","nigeria":"ng","north macedonia":"mk",
      "norway":"no","oman":"om","pakistan":"pk","palau":"pw","panama":"pa","papua new guinea":"pg","paraguay":"py","peru":"pe","philippines":"ph","poland":"pl","portugal":"pt","qatar":"qa",
      "romania":"ro","russia":"ru","russian federation":"ru","rwanda":"rw","saint kitts and nevis":"kn","saint lucia":"lc","saint vincent and the grenadines":"vc","samoa":"ws",
      "san marino":"sm","sao tome and principe":"st","saudi arabia":"sa","senegal":"sn","serbia":"rs","seychelles":"sc","sierra leone":"sl","singapore":"sg","slovakia":"sk","slovenia":"si",
      "solomon islands":"sb","somalia":"so","south africa":"za","spain":"es","sri lanka":"lk","sudan":"sd","south sudan":"ss","suriname":"sr","sweden":"se","switzerland":"ch","syria":"sy",
      "taiwan":"tw","tajikistan":"tj","tanzania":"tz","thailand":"th","timor-leste":"tl","east timor":"tl","togo":"tg","tonga":"to","trinidad and tobago":"tt","tunisia":"tn","turkey":"tr",
      "turkmenistan":"tm","tuvalu":"tv","uganda":"ug","ukraine":"ua","united arab emirates":"ae","united kingdom":"gb","uk":"gb","britain":"gb","england":"gb",
      "united states":"us","united states of america":"us","usa":"us","us":"us","uruguay":"uy","uzbekistan":"uz","vanuatu":"vu","venezuela":"ve","vietnam":"vn","yemen":"ye","zambia":"zm","zimbabwe":"zw"
    };

    /* ========= Init ========= */
    function renderEverything(){
      // set default names in inputs and flags
      byId('a_name').value = A.name;
      byId('b_name').value = B.name;
      loadFlags();

      renderDeck();
      initDrops();
    }
    window.addEventListener('DOMContentLoaded', renderEverything);
  </script>
</body>
</html>
